/* TABLAS ARTICULOS, TIENDAS, FABRICANTES, PEDIDOS y VENTAS*/
/*FABRICANTES*/
CREATE TABLE FABRICANTES(
COD_FABRICANTE INT PRIMARY KEY,
NOMBRE         VARCHAR (30), 
PAIS           VARCHAR (30));

INSERT INTO FABRICANTES VALUES(10,'CALVO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(15,'LU', 'BELGICA');
INSERT INTO FABRICANTES VALUES(20,'BARILLA', 'ITALIA');
INSERT INTO FABRICANTES VALUES(25,'GALLO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(30,'PRESIDENT', 'FRANCIA');

/*ARTÍCULOS*/
CREATE TABLE ARTICULOS(
COD_ARTICULO   INT PRIMARY KEY,
ARTICULO       VARCHAR (20)NOT NULL,
COD_FABRICANTE INT NOT NULL,
PESO           INT NOT NULL ,
CATEGORIA      VARCHAR (10) NOT NULL,
PRECIO_VENTA   DEC (6,2),
PRECIO_COSTO   DEC (6,2),
EXISTENCIAS    INT,
FOREIGN KEY (COD_FABRICANTE) REFERENCES FABRICANTES(COD_FABRICANTE));

INSERT INTO ARTICULOS VALUES (1, 'Macarrones',20, 1, 'Primera',1, 0.98,120);
INSERT INTO ARTICULOS VALUES (2, 'Tallarines',20, 2, 'Primera',1.20,1,100);
INSERT INTO ARTICULOS VALUES (3, 'Tallarines',20, 1, 'Segunda',0.99,0.50,100);
INSERT INTO ARTICULOS VALUES (4, 'Macarrones',20, 1, 'Tercera',0.80,0.50,100);
INSERT INTO ARTICULOS VALUES (5, 'Atún',10, 3, 'Primera',2,1.50,220);
INSERT INTO ARTICULOS VALUES (6, 'Atún',10, 3, 'Segunda',1.50,1,220);
INSERT INTO ARTICULOS VALUES (7, 'Atún',10, 3, 'Tercera',1,0.50,220);
INSERT INTO ARTICULOS VALUES (8, 'Sardinillas',10, 1, 'Primera',2.5,2,200);
INSERT INTO ARTICULOS VALUES (9, 'Sardinillas',10, 1, 'Segunda',2,1.6,200);
INSERT INTO ARTICULOS VALUES (10, 'Sardinillas',10, 1, 'Tercera',1,1.5,220);
INSERT INTO ARTICULOS VALUES (11, 'Mejillones',10, 1, 'Tercera',1,0.9,200);
INSERT INTO ARTICULOS VALUES (12, 'Mejillones',10, 1, 'Primera',3,2,300);
INSERT INTO ARTICULOS VALUES (13, 'Macarrones',25, 1, 'Primera',1.5,1,150);
INSERT INTO ARTICULOS VALUES (14, 'Tallarines',25, 1, 'Primera',1,0.90,100);
INSERT INTO ARTICULOS VALUES (15, 'Fideos',25, 1, 'Segunda',0.75,0.50,100);
INSERT INTO ARTICULOS VALUES (16, 'Fideos',25, 1, 'Primera',1,0.80,100);
INSERT INTO ARTICULOS VALUES (17, 'Galletas Cuadradas',15, 1, 'Primera',2,1.8,100);
INSERT INTO ARTICULOS VALUES (18, 'Galletas Cuadradas',15, 1, 'Segunda',1,0.8,100);
INSERT INTO ARTICULOS VALUES (19, 'Galletas Cuadradas',15, 1, 'Tercera',0.50,0.40,100);
INSERT INTO ARTICULOS VALUES (20, 'Barquillos',15, 1, 'Primera',1,0.80,100);
INSERT INTO ARTICULOS VALUES (21, 'Barquillos',15, 1, 'Segunda',1,0.80,100);
INSERT INTO ARTICULOS VALUES (22, 'Canutillos',15, 2, 'Primera',1.7,1.5,110);
INSERT INTO ARTICULOS VALUES (23, 'Canutillos',15, 2, 'Segunda',1.2,1.5,110);
INSERT INTO ARTICULOS VALUES (24, 'Leche entera',30, 1, 'Primera',1.1,1,300);
INSERT INTO ARTICULOS VALUES (25, 'Leche desnat.',30, 1,'Primera',1.2,1,300);
INSERT INTO ARTICULOS VALUES (26, 'Leche semi.',30, 1, 'Primera',1.30,1.10,300);
INSERT INTO ARTICULOS VALUES (27, 'Leche entera',30, 2,'Primera',2.10,2,300);
INSERT INTO ARTICULOS VALUES (28, 'Leche desnat.',30, 2, 'Primera',2.2,2,300);
INSERT INTO ARTICULOS VALUES (29, 'Leche semi.',30, 2,  'Primera',2.3,2.1,300);
INSERT INTO ARTICULOS VALUES (30, 'Mantequilla',30, 1, 'Primera',1.8,2,200);
INSERT INTO ARTICULOS VALUES (31, 'Mantequilla',30, 1, 'Segunda',1.4,2,200);

/*TIENDAS*/
CREATE TABLE TIENDAS(
NIF       VARCHAR (10) NOT NULL,
NOMBRE    VARCHAR (30),
DIRECCION VARCHAR (30),
POBLACION VARCHAR (30),
PROVINCIA VARCHAR (30),
CODPOSTAL INT);

INSERT INTO TIENDAS VALUES('1111-A','Almacenes Pérez', 'C/Toledo, 20', 'Siguenza', 'GUADALAJARA', 19104); 
INSERT INTO TIENDAS VALUES('5555-B','La gacela', 'C/Santander Rios, 45', 'Azuqueca', 'GUADALAJARA', 19209);
INSERT INTO TIENDAS VALUES('2222-A','Comestibles Rodolfo', 'C/ del Val s/n', 'Alcalá de Henares', 'MADRID', 28804);
INSERT INTO TIENDAS VALUES('4444-A','La Pasta Gansa', 'C/Alcalá, 2', 'Ajalvir', 'MADRID', 28765);
 INSERT INTO TIENDAS VALUES('3333-N','Ultramarinos Montse', 'Avda. Pio 10', 'Toledo', 'TOLEDO', 45100);
INSERT INTO TIENDAS VALUES('4141-B','Todo Toledo', 'C/Avila 24', 'Talavera', 'TOLEDO', 45199);

/*PEDIDOS*/
CREATE TABLE PEDIDOS(
NIF               VARCHAR (10) NOT NULL,
COD_ARTICULO      INT,
FECHA_PEDIDO      DATE NOT NULL,
UNIDADES_PEDIDAS  INT,
PRIMARY KEY (NIF, COD_ARTICULO, FECHA_PEDIDO),
FOREIGN KEY (COD_ARTICULO) REFERENCES ARTICULOS(COD_ARTICULO)) ;

INSERT INTO PEDIDOS VALUES ('5555-B', 1, '2006-02-18', 30);
INSERT INTO PEDIDOS VALUES ('5555-B', 5, '2006-2-21', 10);
INSERT INTO PEDIDOS VALUES ('5555-B', 6, '2006-03-11', 4);
INSERT INTO PEDIDOS VALUES ('5555-B', 9, '2006-03-11', 10);
INSERT INTO PEDIDOS VALUES ('5555-B', 13, '2006-04-14', 12);
INSERT INTO PEDIDOS VALUES ('5555-B',15, '2006-05-18', 24);
INSERT INTO PEDIDOS VALUES ('5555-B', 15, '2006-05-19', 20);
INSERT INTO PEDIDOS VALUES ('5555-B',18,  '2006-06-20', 15);
INSERT INTO PEDIDOS VALUES ('1111-A',20, '2006-02-20', 10);
INSERT INTO PEDIDOS VALUES ('1111-A',22, '2006-04-10', 12);
INSERT INTO PEDIDOS VALUES ('1111-A',26, '2006-6-24', 5);
INSERT INTO PEDIDOS VALUES ('1111-A',27, '2006-07-04', 11);
INSERT INTO PEDIDOS VALUES ('1111-A',30, '2006-07-10', 10);
INSERT INTO PEDIDOS VALUES ('4141-B',1, '2006-04-16', 30);
INSERT INTO PEDIDOS VALUES ('4141-B',5, '2006-06-21', 10);
INSERT INTO PEDIDOS VALUES ('4141-B',6, '2006-08-12', 9);
INSERT INTO PEDIDOS VALUES ('2222-A',9, '2006-08-12', 20);
INSERT INTO PEDIDOS VALUES ('2222-A',10, '2006-08-12', 22);
INSERT INTO PEDIDOS VALUES('2222-A',12, CURDATE(), 1000);
INSERT INTO PEDIDOS VALUES ('3333-A',13,'2006-11-10', 8);
INSERT INTO PEDIDOS VALUES ('3333-A',14, '2006-11-12', 9);
INSERT INTO PEDIDOS VALUES ('3333-A',16, '2006-11-15', 11);
INSERT INTO PEDIDOS VALUES ('3333-A',17, '2006-11-20', 6);
INSERT INTO PEDIDOS VALUES ('3333-A',21, '2006-11-20', 40);
INSERT INTO PEDIDOS VALUES ('3333-A',23,'2006-11-20', 10);


/*VENTAS*/
CREATE TABLE VENTAS(
NIF                VARCHAR (10) NOT NULL,
COD_ARTICULO       INT NOT NULL,
FECHA_VENTA        DATE NOT NULL,
UNIDADES_VENDIDAS  INT,
PRIMARY KEY (NIF, COD_ARTICULO, FECHA_VENTA),
FOREIGN KEY (COD_ARTICULO) REFERENCES ARTICULOS(COD_ARTICULO));


INSERT INTO VENTAS VALUES ('5555-B',1, '2006-02-19', 5);
INSERT INTO VENTAS VALUES ('5555-B',5, '2006-02-19', 6);
INSERT INTO VENTAS VALUES ('5555-B',6, '2006-03-20', 15);
INSERT INTO VENTAS VALUES ('5555-B',9, '2006-03-20', 8);
INSERT INTO VENTAS VALUES ('5555-B',13, '2006-04-17', 2);
INSERT INTO VENTAS VALUES ('5555-B',15, '2006-05-18', 14);
INSERT INTO VENTAS VALUES ('5555-B',26, '2006-06-24', 5);
INSERT INTO VENTAS VALUES ('2222-A',18, '2006-06-20', 5);
INSERT INTO VENTAS VALUES ('2222-A',20, '2006-02-20', 6);
INSERT INTO VENTAS VALUES ('2222-A',23, '2006-06-10', 2);
INSERT INTO VENTAS VALUES ('2222-A',9, '2006-08-15', 5);
INSERT INTO VENTAS VALUES ('2222-A',10, '2006-08-15', 5);
INSERT INTO VENTAS VALUES ('3333-A',29, '2006-07-06', 11);
INSERT INTO VENTAS VALUES ('3333-A',30, '2006-07-16', 10);
INSERT INTO VENTAS VALUES ('3333-A',1, '2006-04-26', 30);
INSERT INTO VENTAS VALUES ('3333-A',5, '2006-04-26', 10);
INSERT INTO VENTAS VALUES ('3333-A',21, '2006-11-25', 4);
INSERT INTO VENTAS VALUES ('3333-A',23, '2006-11-25', 4);
INSERT INTO VENTAS VALUES ('4141-B',6, '2006-08-12', 2);
INSERT INTO VENTAS VALUES ('4141-B',13, '2006-11-10', 2);
INSERT INTO VENTAS VALUES ('4141-B',14, '2006-11-11', 3);
INSERT INTO VENTAS VALUES ('4141-B',23, '2006-11-11', 8);

/*ACTUALIZAR FECHAS*/
UPDATE PEDIDOS
SET FECHA_PEDIDO = DATE_ADD(FECHA_PEDIDO, INTERVAL 19 YEAR);

UPDATE VENTAS
SET FECHA_VENTA = DATE_ADD(FECHA_VENTA, INTERVAL 19 YEAR);


-- =====================================================================================
--                                        EJERCICIOS
-- =====================================================================================
-- 1) Da de alta un nuevo artículo, LENTEJAS, para todos los fabricantes de FRANCIA,
--    de peso 1, de ‘Primera’ categoría, precio venta 1.50, precio costo 1.10 y 100 unidades
--    de existencias.
INSERT INTO ARTICULOS
SELECT (SELECT MAX(COD_ARTICULO) + 1
		FROM ARTICULOS), 'LENTEJAS', F.COD_FABRICANTE, 1, 'PRIMERA', 1.50, 1.10, 100
FROM FABRICANTES F
WHERE PAIS = 'FRANCIA';

-- Una vez añadido, Insertar un Pedido de ese artículo a todas las tiendas para abastecer
-- 5 unidades a cada una y en la fecha de hoy.
INSERT INTO PEDIDOS
SELECT NIF, COD_ARTICULO, CURDATE(), 5
FROM TIENDAS T, ARTICULOS A
WHERE COD_ARTICULO = (SELECT MAX(COD_ARTICULO)
					  FROM ARTICULOS);

-- HACER QUE EL COD_ARTICULO SEA DE AUTOINCREMENTO
ALTER TABLE ARTICULOS
MODIFY COD_ARTICULO INT PRIMARY KEY AUTO_INCREMENT;


-- 2) Da de alta una tienda de NIF 6666-F, llamada ‘COVID-19’, en la ‘C/PANDEMIA,
--    11000’, en FUENLABRADA, en la provincia de MADRID, CodPostal 28940 y
--    abastécela (Añadir PEDIDOS) con 20 unidades de cada uno de los artículos
--    existentes, y fecha de hoy.
INSERT INTO TIENDAS
SELECT '6666-F', 'COVID-19', 'C/PANDEMIA, 11000', 'FUENLABRADA', 'MADRID', 28940;

INSERT INTO PEDIDOS 
SELECT '6666-F', COD_ARTICULO, CURDATE(), 20
FROM ARTICULOS;

-- 3) Abastece todas las tiendas de MADRID (Provincia) con 30 unidades, y fecha de
--    hoy, de todos los artículos de la marca de fabricante GALLO.
INSERT INTO PEDIDOS (NIF, COD_ARTICULO, FECHA_PEDIDO, UNIDADES_PEDIDAS)
SELECT T.NIF, A.COD_ARTICULO, CURDATE(), 30
FROM TIENDAS T, ARTICULOS A
INNER JOIN FABRICANTES F ON A.COD_FABRICANTE = F.COD_FABRICANTE
WHERE T.PROVINCIA = 'MADRID'
AND F.NOMBRE = 'GALLO';

-- 4) Realiza una venta, con fecha de hoy, para todas las tiendas de la provincia de
--    Toledo de 10 unidades en los artículos de primera categoría.
INSERT INTO VENTAS
SELECT T.NIF, A.COD_ARTICULO, CURDATE(), 10
FROM TIENDAS T, ARTICULOS A
WHERE T.PROVINCIA = 'TOLEDO'
AND A.CATEGORIA = 'PRIMERA';

-- 5) Cambia el NIF y el NOMBRE de la tienda con NIF‘1111-A’, igualándolos a los de
--    la tienda con NIF ‘2222-A’. Nota.- Como no se puede usar la misma tabla que se
--    está modificando como origen de los nuevos datos hay que hacerlo en dos
--    pasos:
-- 			a) Crear una tabla auxiliar (llamada TIENDAS2) con los mismos datos que TIENDAS.
-- 			b) Usar la tabla TIENDAS2 en el SELECT del UPDATE
CREATE TABLE TIENDAS2
(SELECT *
 FROM TIENDAS);
 
 UPDATE TIENDAS
 SET NIF = (SELECT NIF
			FROM TIENDAS2
            WHERE NIF = '2222-A'),
	  NOMBRE = (SELECT NOMBRE
				FROM TIENDAS2
                WHERE NIF = '2222-A')
WHERE NIF = '1111-A';

-- 6) Cambia todos los artículos de ‘Primera’ categoría a ‘Segunda’ categoría del país
--    ‘ITALIA’.
UPDATE ARTICULOS
SET CATEGORIA = 'Segunda'
WHERE CATEGORIA = 'Primera'
AND COD_FABRICANTE IN (SELECT COD_FABRICANTE 
					   FROM FABRICANTES 
                       WHERE PAIS = 'ITALIA');

-- 7) Modifica aquellos pedidos en los que la cantidad pedida sea superior a las
-- existencias del artículo, asignando el 20% de las existencias a la cantidad que se ha
-- pedido.
UPDATE PEDIDOS P
INNER JOIN ARTICULOS A ON A.COD_ARTICULO = P.COD_ARTICULO
SET UNIDADES_PEDIDAS = (0.2 * EXISTENCIAS)
WHERE UNIDADES_PEDIDAS > EXISTENCIAS;


UPDATE PEDIDOS
SET UNIDADES_PEDIDAS = (SELECT 0.20*EXISTENCIAS
						FROM ARTICULOS A
                        WHERE A.COD_ARTICULO = PEDIDOS.CODARTICULO)
WHERE UNIDADES_PEDIDAS > (SELECT EXISTENCIAS
						  FROM ARTICULOS A
                          WHERE A.COD_ARTICULO = PEDIDOS.CODARTICULO);

-- 8) Elimina aquellas tiendas que no han realizado ventas.
DELETE T.*
FROM TIENDAS T 
WHERE NIF NOT IN (SELECT DISTINCT NIF
				  FROM VENTAS V);
                  
-- 9) Elimina los artículos que no hayan tenido ni PEDIDOS ni VENTAS.
DELETE A.*
FROM ARTICULOS A
WHERE COD_ARTICULO NOT IN (SELECT DISTINCT V.COD_ARTICULO
						   FROM VENTAS V) AND COD_ARTICULO NOT IN (SELECT DISTINCT P.COD_ARTICULO
																   FROM PEDIDOS P);














